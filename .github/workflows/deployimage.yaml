name: Deploy Docker Image

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name petdistriACR

      - name: Deploy Docker Image
        run: |
          ORIGINAL_IMAGE_NAME="petdistriacr.azurecr.io/spring-petclinic-vets-service:pr-${{ github.event.pull_request.number }}"
          NEW_IMAGE_NAME="petdistriacr.azurecr.io/spring-petclinic-vets-service:deploy-${{ github.run_number }}"

          echo "Original image: $ORIGINAL_IMAGE_NAME"
          echo "New image: $NEW_IMAGE_NAME"

          # Renombrar la imagen
          docker pull $ORIGINAL_IMAGE_NAME
          docker tag $ORIGINAL_IMAGE_NAME $NEW_IMAGE_NAME

          # Subir la nueva imagen al ACR
          docker push $NEW_IMAGE_NAME
